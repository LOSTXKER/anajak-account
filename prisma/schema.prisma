// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 1. TENANTS & COMPANIES (Multi-tenant Support)
// ============================================================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  plan      String   @default("free") // free, starter, pro, enterprise
  status    String   @default("active") // active, suspended, cancelled
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  companies Company[]
  users     User[]

  @@map("tenants")
}

model Company {
  id          String  @id @default(uuid())
  tenantId    String  @map("tenant_id")
  name        String
  nameEn      String? @map("name_en")
  taxId       String? @map("tax_id")
  branchCode  String  @default("00000") @map("branch_code")
  phone       String?
  email       String?
  address     String?
  district    String?
  subDistrict String? @map("sub_district")
  province    String?
  postalCode  String? @map("postal_code")
  country     String  @default("Thailand")

  // Settings
  fiscalYearStart   Int     @default(1) @map("fiscal_year_start")
  defaultCurrency   String  @default("THB") @map("default_currency")
  vatRegistered     Boolean @default(true) @map("vat_registered")
  vatRate           Decimal @default(7.00) @map("vat_rate") @db.Decimal(5, 2)
  logoUrl           String? @map("logo_url")
  documentSettings  Json?   @map("document_settings")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  contacts         Contact[]
  products         Product[]
  productCategories ProductCategory[]
  accounts         Account[]
  documents        Document[]
  payments         Payment[]
  journalEntries   JournalEntry[]
  userCompanies    UserCompany[]

  @@map("companies")
}

// ============================================================================
// 2. USERS & AUTH
// ============================================================================

model User {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  email         String
  passwordHash  String?  @map("password_hash")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  phone         String?
  avatarUrl     String?  @map("avatar_url")
  language      String   @default("th")
  timezone      String   @default("Asia/Bangkok")
  status        String   @default("active")
  emailVerified DateTime? @map("email_verified_at")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  userCompanies UserCompany[]
  documents     Document[]

  @@unique([tenantId, email])
  @@map("users")
}

model Role {
  id          String  @id @default(uuid())
  tenantId    String? @map("tenant_id")
  name        String
  description String?
  isSystem    Boolean @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userCompanies UserCompany[]

  @@map("roles")
}

model UserCompany {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  companyId  String   @map("company_id")
  roleId     String   @map("role_id")
  isDefault  Boolean  @default(false) @map("is_default")
  createdAt  DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role    Role    @relation(fields: [roleId], references: [id])

  @@unique([userId, companyId])
  @@map("user_companies")
}

// ============================================================================
// 3. CONTACTS (Customers/Vendors)
// ============================================================================

model Contact {
  id             String   @id @default(uuid())
  companyId      String   @map("company_id")
  type           String   // customer, vendor, both
  code           String?
  name           String
  nameEn         String?  @map("name_en")
  taxId          String?  @map("tax_id")
  branchCode     String   @default("00000") @map("branch_code")
  contactName    String?  @map("contact_name")
  phone          String?
  email          String?
  creditTerm     Int      @default(30) @map("credit_term")
  creditLimit    Decimal? @map("credit_limit") @db.Decimal(15, 2)
  defaultWhtRate Decimal? @map("default_wht_rate") @db.Decimal(5, 2)
  tags           Json?    @default("[]")
  notes          String?  @db.Text
  isActive       Boolean  @default(true) @map("is_active")
  isBlacklisted  Boolean  @default(false) @map("is_blacklisted")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  createdBy      String?  @map("created_by")

  company   Company           @relation(fields: [companyId], references: [id])
  addresses ContactAddress[]
  documents Document[]
  payments  Payment[]

  @@unique([companyId, code])
  @@map("contacts")
}

model ContactAddress {
  id          String   @id @default(uuid())
  contactId   String   @map("contact_id")
  type        String   // billing, shipping, head_office, branch
  label       String?
  address     String
  district    String?
  subDistrict String?  @map("sub_district")
  province    String?
  postalCode  String?  @map("postal_code")
  country     String   @default("Thailand")
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("contact_addresses")
}

// ============================================================================
// 4. PRODUCTS & SERVICES
// ============================================================================

model ProductCategory {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  parentId    String?  @map("parent_id")
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  company  Company   @relation(fields: [companyId], references: [id])
  products Product[]

  @@map("product_categories")
}

model Product {
  id                  String   @id @default(uuid())
  companyId           String   @map("company_id")
  categoryId          String?  @map("category_id")
  type                String   // product, service, bundle
  code                String?
  barcode             String?
  name                String
  nameEn              String?  @map("name_en")
  description         String?  @db.Text
  unit                String?
  salePrice           Decimal  @default(0) @map("sale_price") @db.Decimal(15, 2)
  purchasePrice       Decimal  @default(0) @map("purchase_price") @db.Decimal(15, 2)
  isVatable           Boolean  @default(true) @map("is_vatable")
  vatType             String   @default("vat7") @map("vat_type") // vat7, vat0, non_vat
  trackInventory      Boolean  @default(false) @map("track_inventory")
  minStock            Decimal  @default(0) @map("min_stock") @db.Decimal(15, 2)
  incomeAccountId     String?  @map("income_account_id")
  expenseAccountId    String?  @map("expense_account_id")
  inventoryAccountId  String?  @map("inventory_account_id")
  imageUrl            String?  @map("image_url")
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  company         Company          @relation(fields: [companyId], references: [id])
  category        ProductCategory? @relation(fields: [categoryId], references: [id])
  incomeAccount   Account?         @relation("ProductIncomeAccount", fields: [incomeAccountId], references: [id])
  expenseAccount  Account?         @relation("ProductExpenseAccount", fields: [expenseAccountId], references: [id])
  inventoryAccount Account?        @relation("ProductInventoryAccount", fields: [inventoryAccountId], references: [id])
  documentLines   DocumentLine[]

  @@unique([companyId, code])
  @@map("products")
}

// ============================================================================
// 5. CHART OF ACCOUNTS
// ============================================================================

model AccountType {
  id            String  @id @default(uuid())
  code          String  @unique
  name          String
  nameEn        String? @map("name_en")
  normalBalance String  @map("normal_balance") // debit, credit
  displayOrder  Int?    @map("display_order")

  accounts Account[]

  @@map("account_types")
}

model Account {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  accountTypeId   String   @map("account_type_id")
  parentId        String?  @map("parent_id")
  code            String
  name            String
  nameEn          String?  @map("name_en")
  description     String?  @db.Text
  isHeader        Boolean  @default(false) @map("is_header")
  isSystem        Boolean  @default(false) @map("is_system")
  isBank          Boolean  @default(false) @map("is_bank")
  bankName        String?  @map("bank_name")
  bankBranch      String?  @map("bank_branch")
  bankAccountNo   String?  @map("bank_account_number")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  company            Company        @relation(fields: [companyId], references: [id])
  accountType        AccountType    @relation(fields: [accountTypeId], references: [id])
  journalLines       JournalLine[]
  productsIncome     Product[]      @relation("ProductIncomeAccount")
  productsExpense    Product[]      @relation("ProductExpenseAccount")
  productsInventory  Product[]      @relation("ProductInventoryAccount")

  @@unique([companyId, code])
  @@map("accounts")
}

// ============================================================================
// 6. DOCUMENTS
// ============================================================================

model DocumentType {
  id           String  @id @default(uuid())
  code         String  @unique
  name         String
  nameEn       String? @map("name_en")
  category     String  // sales, purchase, inventory, journal
  canConvertTo Json?   @default("[]") @map("can_convert_to")
  displayOrder Int?    @map("display_order")

  documents Document[]

  @@map("document_types")
}

model Document {
  id                 String    @id @default(uuid())
  companyId          String    @map("company_id")
  documentTypeId     String    @map("document_type_id")
  documentNumber     String    @map("document_number")
  referenceNumber    String?   @map("reference_number")
  contactId          String?   @map("contact_id")
  contactName        String?   @map("contact_name")
  contactAddress     String?   @db.Text @map("contact_address")
  contactTaxId       String?   @map("contact_tax_id")
  documentDate       DateTime  @map("document_date") @db.Date
  dueDate            DateTime? @map("due_date") @db.Date
  subtotal           Decimal   @default(0) @db.Decimal(15, 2)
  discountAmount     Decimal   @default(0) @map("discount_amount") @db.Decimal(15, 2)
  amountBeforeVat    Decimal   @default(0) @map("amount_before_vat") @db.Decimal(15, 2)
  vatAmount          Decimal   @default(0) @map("vat_amount") @db.Decimal(15, 2)
  whtAmount          Decimal   @default(0) @map("wht_amount") @db.Decimal(15, 2)
  totalAmount        Decimal   @default(0) @map("total_amount") @db.Decimal(15, 2)
  currency           String    @default("THB")
  exchangeRate       Decimal   @default(1) @map("exchange_rate") @db.Decimal(15, 6)
  status             String    @default("draft")
  paidAmount         Decimal   @default(0) @map("paid_amount") @db.Decimal(15, 2)
  sourceDocumentId   String?   @map("source_document_id")
  journalEntryId     String?   @map("journal_entry_id")
  notes              String?   @db.Text
  customerNotes      String?   @db.Text @map("customer_notes")
  sentAt             DateTime? @map("sent_at")
  viewedAt           DateTime? @map("viewed_at")
  voidedAt           DateTime? @map("voided_at")
  voidReason         String?   @db.Text @map("void_reason")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  createdBy          String?   @map("created_by")
  approvedBy         String?   @map("approved_by")
  approvedAt         DateTime? @map("approved_at")

  company       Company        @relation(fields: [companyId], references: [id])
  documentType  DocumentType   @relation(fields: [documentTypeId], references: [id])
  contact       Contact?       @relation(fields: [contactId], references: [id])
  creator       User?          @relation(fields: [createdBy], references: [id])
  journalEntry  JournalEntry?  @relation(fields: [journalEntryId], references: [id])
  lines         DocumentLine[]

  @@unique([companyId, documentTypeId, documentNumber])
  @@map("documents")
}

model DocumentLine {
  id              String  @id @default(uuid())
  documentId      String  @map("document_id")
  lineNumber      Int     @map("line_number")
  productId       String? @map("product_id")
  productCode     String? @map("product_code")
  productName     String  @map("product_name")
  description     String? @db.Text
  quantity        Decimal @default(1) @db.Decimal(15, 4)
  unit            String?
  unitPrice       Decimal @default(0) @map("unit_price") @db.Decimal(15, 4)
  discountPercent Decimal @default(0) @map("discount_percent") @db.Decimal(5, 2)
  discountAmount  Decimal @default(0) @map("discount_amount") @db.Decimal(15, 2)
  amount          Decimal @default(0) @db.Decimal(15, 2)
  vatType         String  @default("vat7") @map("vat_type")
  vatAmount       Decimal @default(0) @map("vat_amount") @db.Decimal(15, 2)
  whtRate         Decimal @default(0) @map("wht_rate") @db.Decimal(5, 2)
  whtAmount       Decimal @default(0) @map("wht_amount") @db.Decimal(15, 2)
  accountId       String? @map("account_id")
  createdAt       DateTime @default(now()) @map("created_at")

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id])

  @@map("document_lines")
}

// ============================================================================
// 7. PAYMENTS
// ============================================================================

model Payment {
  id              String   @id @default(uuid())
  companyId       String   @map("company_id")
  type            String   // receive, pay
  paymentNumber   String   @map("payment_number")
  contactId       String?  @map("contact_id")
  amount          Decimal  @db.Decimal(15, 2)
  currency        String   @default("THB")
  paymentMethod   String   @map("payment_method") // cash, transfer, cheque, credit_card
  bankAccountId   String?  @map("bank_account_id")
  referenceNumber String?  @map("reference_number")
  chequeNumber    String?  @map("cheque_number")
  chequeDate      DateTime? @map("cheque_date") @db.Date
  chequeBank      String?  @map("cheque_bank")
  paymentDate     DateTime @map("payment_date") @db.Date
  status          String   @default("completed")
  journalEntryId  String?  @map("journal_entry_id")
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  createdBy       String?  @map("created_by")

  company      Company       @relation(fields: [companyId], references: [id])
  contact      Contact?      @relation(fields: [contactId], references: [id])
  journalEntry JournalEntry? @relation(fields: [journalEntryId], references: [id])

  @@unique([companyId, paymentNumber])
  @@map("payments")
}

// ============================================================================
// 8. JOURNAL ENTRIES
// ============================================================================

model JournalEntry {
  id           String   @id @default(uuid())
  companyId    String   @map("company_id")
  entryNumber  String   @map("entry_number")
  sourceType   String?  @map("source_type")
  sourceId     String?  @map("source_id")
  entryDate    DateTime @map("entry_date") @db.Date
  fiscalYear   Int      @map("fiscal_year")
  fiscalMonth  Int      @map("fiscal_month")
  totalDebit   Decimal  @map("total_debit") @db.Decimal(15, 2)
  totalCredit  Decimal  @map("total_credit") @db.Decimal(15, 2)
  description  String?  @db.Text
  status       String   @default("posted")
  isReversal   Boolean  @default(false) @map("is_reversal")
  createdAt    DateTime @default(now()) @map("created_at")
  createdBy    String?  @map("created_by")

  company  Company       @relation(fields: [companyId], references: [id])
  lines    JournalLine[]
  documents Document[]
  payments Payment[]

  @@unique([companyId, entryNumber])
  @@map("journal_entries")
}

model JournalLine {
  id           String  @id @default(uuid())
  journalEntryId String @map("journal_entry_id")
  lineNumber   Int     @map("line_number")
  accountId    String  @map("account_id")
  debitAmount  Decimal @default(0) @map("debit_amount") @db.Decimal(15, 2)
  creditAmount Decimal @default(0) @map("credit_amount") @db.Decimal(15, 2)
  description  String? @db.Text
  contactId    String? @map("contact_id")
  createdAt    DateTime @default(now()) @map("created_at")

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id])

  @@map("journal_lines")
}
